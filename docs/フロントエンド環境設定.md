# フロントエンド環境切り替えガイド

Speed Match Card Game フロントエンドアプリケーションの環境切り替え方法について説明します。

## 概要

このプロジェクトでは、Viteの環境変数機能とモード機能を使用して、開発・ステージング・本番環境を切り替えることができます。

## 環境変数ファイルの構成

Viteは以下の順序で環境変数ファイルを読み込みます（後から読み込まれたファイルが優先されます）：

1. `.env` - 全モード共通
2. `.env.local` - 全モード共通（gitignoreに追加推奨）
3. `.env.[mode]` - 指定されたモード専用
4. `.env.[mode].local` - 指定されたモード専用（gitignoreに追加推奨）

### ファイル構成例

```
front/
├── .env                 # 全環境共通設定
├── .env.local           # ローカル固有設定（gitignore対象）
├── .env.development     # 開発環境設定
├── .env.staging         # ステージング環境設定
├── .env.production      # 本番環境設定
└── .env.production.local # 本番環境ローカル設定（gitignore対象）
```

## 環境変数ファイルの設定例

### `.env` （全環境共通）
```env
# アプリケーション基本情報
VITE_APP_NAME=Speed Match Card Game
VITE_APP_VERSION=1.0.0
```

### `.env.development` （開発環境）
```env
# 開発環境設定
VITE_API_BASE_URL=http://localhost:8080
VITE_DEBUG_MODE=true
VITE_LOG_LEVEL=debug
VITE_ENABLE_MOCK=true
VITE_HOT_RELOAD=true
```

### `.env.staging` （ステージング環境）
```env
# ステージング環境設定
VITE_API_BASE_URL=https://staging-api.speedmatch.com
VITE_DEBUG_MODE=true
VITE_LOG_LEVEL=warn
VITE_ENABLE_MOCK=false
VITE_ANALYTICS_ID=GA-STAGING-ID
```

### `.env.production` （本番環境）
```env
# 本番環境設定
VITE_API_BASE_URL=https://api.speedmatch.com
VITE_DEBUG_MODE=false
VITE_LOG_LEVEL=error
VITE_ENABLE_MOCK=false
VITE_ANALYTICS_ID=GA-PRODUCTION-ID
```

### `.env.local` （ローカル固有設定）
```env
# 個人開発環境用の設定（gitignore対象）
VITE_DEV_PORT=3001
VITE_PERSONAL_API_KEY=your-personal-api-key
```

## package.json スクリプト設定

環境別のビルド・実行スクリプトを設定します：

```json
{
  "scripts": {
    "dev": "vite",
    "dev:staging": "vite --mode staging",
    "build": "tsc -b && vite build",
    "build:dev": "tsc -b && vite build --mode development",
    "build:staging": "tsc -b && vite build --mode staging",
    "build:prod": "tsc -b && vite build --mode production",
    "preview": "vite preview",
    "preview:staging": "vite preview --mode staging"
  }
}
```

## コマンド使用例

### 開発サーバーの起動

```bash
# 開発モード（デフォルト）
npm run dev

# ステージングモードで開発サーバー起動
npm run dev:staging

# 特定のモードを指定
vite --mode development
```

### ビルド

```bash
# 開発用ビルド
npm run build:dev

# ステージング用ビルド
npm run build:staging

# 本番用ビルド
npm run build:prod

# または直接コマンド指定
vite build --mode production
```

### プレビュー

```bash
# ビルド後のプレビュー（本番モード）
npm run preview

# ステージングモードでプレビュー
npm run preview:staging
```

## React アプリケーションでの環境変数使用

### 設定ファイル作成

```typescript
// src/config/env.ts
export const config = {
  appName: import.meta.env.VITE_APP_NAME,
  appVersion: import.meta.env.VITE_APP_VERSION,
  apiBaseUrl: import.meta.env.VITE_API_BASE_URL,
  debugMode: import.meta.env.VITE_DEBUG_MODE === 'true',
  logLevel: import.meta.env.VITE_LOG_LEVEL,
  enableMock: import.meta.env.VITE_ENABLE_MOCK === 'true',
  analyticsId: import.meta.env.VITE_ANALYTICS_ID,
}
```

### アプリケーションでの使用例

```typescript
// src/App.tsx
import { config } from './config/env'

function App() {
  console.log(`Running ${config.appName} v${config.appVersion}`)
  console.log(`API Base URL: ${config.apiBaseUrl}`)
  console.log(`Debug Mode: ${config.debugMode}`)
  
  return (
    <div>
      {config.debugMode && (
        <div className="debug-banner">
          Debug Mode Enabled - Environment: {import.meta.env.MODE}
        </div>
      )}
      {/* アプリケーションコンテンツ */}
    </div>
  )
}
```

## vite.config.ts での高度な設定

環境に応じた詳細なビルド設定：

```typescript
import { defineConfig, loadEnv } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig(({ command, mode }) => {
  // 環境変数を読み込み
  const env = loadEnv(mode, process.cwd(), '')
  
  console.log(`Building in ${mode} mode`)
  
  return {
    plugins: [react()],
    
    // 環境変数をクライアントサイドで使用可能にする
    define: {
      __APP_VERSION__: JSON.stringify(env.VITE_APP_VERSION),
      __BUILD_MODE__: JSON.stringify(mode),
      __BUILD_TIME__: JSON.stringify(new Date().toISOString()),
    },
    
    // ビルド設定を環境に応じて変更
    build: {
      // ソースマップは開発・ステージング環境のみ
      sourcemap: mode === 'development' || mode === 'staging',
      
      // 本番環境では最適化を強化
      minify: mode === 'production' ? 'esbuild' : false,
      
      // 出力ディレクトリ指定
      outDir: env.VITE_OUTPUT_DIR || 'dist',
      
      // 本番環境でのバンドル最適化
      rollupOptions: mode === 'production' ? {
        output: {
          manualChunks: {
            vendor: ['react', 'react-dom'],
          },
        },
      } : {},
    },
    
    // 開発サーバー設定
    server: {
      port: parseInt(env.VITE_DEV_PORT) || 3000,
      proxy: env.VITE_API_BASE_URL ? {
        '/api': {
          target: env.VITE_API_BASE_URL,
          changeOrigin: true,
        }
      } : {},
    },
  }
})
```

## CI/CD での活用

### AWS CodeBuild での設定例

```yaml
# buildspec-frontend.yml
version: 0.2

phases:
  pre_build:
    commands:
      - echo "Setting environment variables..."
      - export VITE_BUILD_TIME=$(date -Iseconds)
      - export VITE_COMMIT_HASH=$CODEBUILD_RESOLVED_SOURCE_VERSION
      - export VITE_BUILD_NUMBER=$CODEBUILD_BUILD_NUMBER
      
  build:
    commands:
      - echo "Building for $BUILD_ENV environment..."
      - cd front
      - npm ci --production=false
      # 環境変数 BUILD_ENV に応じてビルド
      - npm run build:$BUILD_ENV
```

### GitHub Actions での設定例

```yaml
# .github/workflows/build.yml
name: Build Frontend

on:
  push:
    branches: [main, develop, staging]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - uses: actions/setup-node@v3
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: front/package-lock.json
      
      - name: Install dependencies
        run: |
          cd front
          npm ci --production=false
      
      - name: Build for staging
        if: github.ref == 'refs/heads/staging'
        run: |
          cd front
          npm run build:staging
      
      - name: Build for production
        if: github.ref == 'refs/heads/main'
        run: |
          cd front
          npm run build:prod
```

## 環境変数の型安全性

TypeScriptで環境変数の型安全性を確保：

```typescript
// src/types/env.d.ts
/// <reference types="vite/client" />

interface ImportMetaEnv {
  readonly VITE_APP_NAME: string
  readonly VITE_APP_VERSION: string
  readonly VITE_API_BASE_URL: string
  readonly VITE_DEBUG_MODE: string
  readonly VITE_LOG_LEVEL: 'debug' | 'info' | 'warn' | 'error'
  readonly VITE_ENABLE_MOCK: string
  readonly VITE_ANALYTICS_ID?: string
}

interface ImportMeta {
  readonly env: ImportMetaEnv
}
```

## セキュリティ注意点

### 重要な注意事項

1. **VITE_プレフィックス**: クライアントサイドで使用する環境変数は必ず`VITE_`で始める
2. **機密情報の取り扱い**: APIキーなど機密情報は`.env.local`に保存し、gitignoreに追加
3. **公開される情報**: `VITE_`で始まる環境変数はビルド時にクライアントサイドコードに埋め込まれ、ブラウザで閲覧可能
4. **バージョン管理**: `.env.local`ファイルはgitにコミットしない

### .gitignoreの設定

```gitignore
# ローカル環境変数ファイル
.env.local
.env.*.local

# 本番環境固有の設定（必要に応じて）
.env.production.local
```

## トラブルシューティング

### よくある問題と解決方法

1. **環境変数が読み込まれない**
   - `VITE_`プレフィックスがついているか確認
   - ファイル名が正しいか確認（`.env.production` など）
   - キャッシュをクリアして再起動

2. **モードが切り替わらない**
   - `--mode` オプションが正しく指定されているか確認
   - 対応する`.env.[mode]`ファイルが存在するか確認

3. **ビルド時にエラーが発生**
   - TypeScriptの型定義が正しいか確認
   - 必須の環境変数が設定されているか確認

### デバッグ方法

```typescript
// 現在の環境変数を確認
console.log('Current mode:', import.meta.env.MODE)
console.log('Environment variables:', import.meta.env)

// vite.config.tsでの確認
export default defineConfig(({ mode }) => {
  const env = loadEnv(mode, process.cwd(), '')
  console.log(`Mode: ${mode}`)
  console.log('Loaded env:', env)
  
  // ...
})
```

## まとめ

この環境切り替えシステムにより、以下のメリットを得られます：

- **環境別の設定管理**: 開発・ステージング・本番で異なる設定を自動切り替え
- **コマンド一つで切り替え**: `--mode` オプションで簡単に環境を指定
- **型安全性**: TypeScriptによる環境変数の型チェック
- **CI/CD対応**: 自動ビルド・デプロイでの環境切り替え
- **セキュリティ**: 機密情報の適切な管理

この設定により、効率的で安全な環境管理が可能になります。