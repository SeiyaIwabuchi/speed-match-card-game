# ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒãƒƒãƒ æœ€çµ‚ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ

## ğŸ—ï¸ ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼ˆç¢ºå®šç‰ˆï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Internet                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   S3 é™çš„ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°   â”‚ â† ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ (React)
          â”‚   (ãƒã‚±ãƒƒãƒˆãƒãƒªã‚·ãƒ¼)    â”‚    æœˆé¡ $0-1
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â†“ API Request (ç›´æ¥)
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   EC2 t3.micro (Amazon Linux 2023)â”‚
          â”‚   Public IP: xx.xx.xx.xx          â”‚
          â”‚   æœˆé¡ $0 (ç„¡æ–™æ )                 â”‚
          â”‚                                    â”‚
          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
          â”‚  â”‚ Docker Compose               â”‚ â”‚
          â”‚  â”‚                              â”‚ â”‚
          â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
          â”‚  â”‚  â”‚ Nginx                  â”‚ â”‚ â”‚
          â”‚  â”‚  â”‚ Port: 80, 443         â”‚ â”‚ â”‚
          â”‚  â”‚  â”‚ (ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·)     â”‚ â”‚ â”‚
          â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
          â”‚  â”‚           â†“                 â”‚ â”‚
          â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
          â”‚  â”‚  â”‚ Node.js API Server     â”‚ â”‚ â”‚
          â”‚  â”‚  â”‚ Port: 3000            â”‚ â”‚ â”‚
          â”‚  â”‚  â”‚ Express + PostgreSQL  â”‚ â”‚ â”‚
          â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
          â”‚  â”‚           â†“                 â”‚ â”‚
          â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
          â”‚  â”‚  â”‚ PostgreSQL 15          â”‚ â”‚ â”‚
          â”‚  â”‚  â”‚ Port: 5432            â”‚ â”‚ â”‚
          â”‚  â”‚  â”‚ Data: /postgres_data  â”‚ â”‚ â”‚
          â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†‘
                       â”‚ SSH Deploy
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   AWS CodePipeline     â”‚
          â”‚                        â”‚
          â”‚  GitHub â†’ CodeBuild â†’  â”‚
          â”‚  SSH Deploy to EC2     â”‚
          â”‚                        â”‚
          â”‚  æœˆé¡ $0 (1ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³)â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ æ§‹æˆè¦ç´ ã®è©³ç´°

### 1. EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼ˆã™ã¹ã¦ã‚’ã“ã“ã«é›†ç´„ï¼‰

#### ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä»•æ§˜
```yaml
åå‰: speedmatch-server
ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—: t3.micro
  - vCPU: 2
  - RAM: 1GB
  - ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯: æœ€å¤§5 Gbps

AMI: Amazon Linux 2023 (æœ€æ–°)
EBS: 30GB gp3ï¼ˆç„¡æ–™æ ï¼‰

ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯:
  - VPC: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆVPC
  - ã‚µãƒ–ãƒãƒƒãƒˆ: ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚µãƒ–ãƒãƒƒãƒˆ
  - ãƒ‘ãƒ–ãƒªãƒƒã‚¯IP: è‡ªå‹•å‰²ã‚Šå½“ã¦
  - Elastic IP: ä¸ä½¿ç”¨ï¼ˆã‚³ã‚¹ãƒˆå‰Šæ¸›ï¼‰

ã‚­ãƒ¼ãƒšã‚¢: speedmatch-key.pem

ã‚¿ã‚°:
  Name: speedmatch-server
  Environment: development
  Project: speedmatch

ã‚³ã‚¹ãƒˆ: $0/æœˆï¼ˆç„¡æ–™æ 750æ™‚é–“ï¼‰
```

#### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—
```yaml
åå‰: speedmatch-sg
èª¬æ˜: Security group for SpeedMatch server

ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰ãƒ«ãƒ¼ãƒ«:
  - Type: SSH
    Protocol: TCP
    Port: 22
    Source: ãƒã‚¤IP/32
    èª¬æ˜: ç®¡ç†ç”¨SSHï¼ˆã‚»ã‚­ãƒ¥ã‚¢ãªæ¥ç¶šå…ƒã®ã¿ï¼‰
  
  - Type: HTTP
    Protocol: TCP
    Port: 80
    Source: 0.0.0.0/0
    èª¬æ˜: HTTPã‚¢ã‚¯ã‚»ã‚¹
  
  - Type: HTTPS
    Protocol: TCP
    Port: 443
    Source: 0.0.0.0/0
    èª¬æ˜: HTTPSã‚¢ã‚¯ã‚»ã‚¹
  
  - Type: Custom TCP
    Protocol: TCP
    Port: 3000
    Source: 0.0.0.0/0
    èª¬æ˜: APIç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆé–‹ç™ºç”¨ã€æœ¬ç•ªã§ã¯å‰Šé™¤æ¨å¥¨ï¼‰

ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰ãƒ«ãƒ¼ãƒ«:
  - Type: All traffic
    Protocol: All
    Port: All
    Destination: 0.0.0.0/0
```

#### IAM ãƒ­ãƒ¼ãƒ«
```yaml
ãƒ­ãƒ¼ãƒ«å: speedmatch-ec2-role

ãƒãƒªã‚·ãƒ¼:
  - AmazonSSMManagedInstanceCoreï¼ˆSystems Managerç”¨ï¼‰
  - ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªã‚·ãƒ¼ï¼ˆS3, Secrets Managerï¼‰

ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªã‚·ãƒ¼:
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:PutObject"
      ],
      "Resource": "arn:aws:s3:::speedmatch-*/*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "secretsmanager:GetSecretValue"
      ],
      "Resource": "arn:aws:secretsmanager:*:*:secret:speedmatch/*"
    }
  ]
}
```

---

### 2. Docker Compose æ§‹æˆ

#### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 
```
/home/ec2-user/speedmatch/
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ .env
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ src/
â”‚   â””â”€â”€ ...
â”œâ”€â”€ nginx/
â”‚   â”œâ”€â”€ nginx.conf
â”‚   â””â”€â”€ ssl/
â”‚       â”œâ”€â”€ cert.pem
â”‚       â””â”€â”€ key.pem
â””â”€â”€ postgres_data/ï¼ˆDocker volumeï¼‰
```

#### docker-compose.yml
```yaml
version: '3.8'

services:
  nginx:
    image: nginx:alpine
    container_name: speedmatch-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - api
    restart: unless-stopped
    networks:
      - speedmatch-network
    mem_limit: 128m
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  api:
    build: ./api
    container_name: speedmatch-api
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=speedmatch
      - DB_USER=admin
      - DB_PASSWORD=${DB_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
      - CORS_ORIGIN=${CORS_ORIGIN}
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - speedmatch-network
    mem_limit: 512m
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  postgres:
    image: postgres:15-alpine
    container_name: speedmatch-postgres
    environment:
      - POSTGRES_DB=speedmatch
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --locale=C
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    restart: unless-stopped
    networks:
      - speedmatch-network
    mem_limit: 256m
    command:
      - "postgres"
      - "-c"
      - "max_connections=50"
      - "-c"
      - "shared_buffers=128MB"
      - "-c"
      - "effective_cache_size=256MB"
      - "-c"
      - "maintenance_work_mem=64MB"
      - "-c"
      - "checkpoint_completion_target=0.9"
      - "-c"
      - "wal_buffers=4MB"
      - "-c"
      - "default_statistics_target=100"
      - "-c"
      - "random_page_cost=1.1"
      - "-c"
      - "effective_io_concurrency=200"
      - "-c"
      - "work_mem=2621kB"
      - "-c"
      - "min_wal_size=1GB"
      - "-c"
      - "max_wal_size=4GB"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d speedmatch"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  speedmatch-network:
    driver: bridge

volumes:
  postgres_data:
    driver: local
```

#### .envï¼ˆç’°å¢ƒå¤‰æ•°ï¼‰
```bash
# Database
DB_PASSWORD=your_secure_password_here_change_me

# JWT
JWT_SECRET=your_jwt_secret_key_change_me

# CORS
CORS_ORIGIN=http://speedmatch-frontend.s3-website-ap-northeast-1.amazonaws.com

# App
NODE_ENV=production
PORT=3000
```

#### nginx/nginx.conf
```nginx
events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # ãƒ­ã‚°è¨­å®š
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # åŸºæœ¬è¨­å®š
    sendfile on;
    keepalive_timeout 65;
    client_max_body_size 10M;

    # gzipåœ§ç¸®
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    upstream api {
        server api:3000;
    }

    # HTTPã‚µãƒ¼ãƒãƒ¼
    server {
        listen 80;
        server_name _;

        # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
        location /health {
            proxy_pass http://api/health;
            access_log off;
        }

        # APIãƒ—ãƒ­ã‚­ã‚·
        location / {
            proxy_pass http://api;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # CORSè¨­å®šï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization' always;

            if ($request_method = 'OPTIONS') {
                return 204;
            }

            # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }
    }

    # HTTPSã‚µãƒ¼ãƒãƒ¼ï¼ˆSSLè¨¼æ˜æ›¸è¨­å®šæ™‚ï¼‰
    # server {
    #     listen 443 ssl;
    #     server_name api.yourdomain.com;
    #
    #     ssl_certificate /etc/nginx/ssl/cert.pem;
    #     ssl_certificate_key /etc/nginx/ssl/key.pem;
    #
    #     location / {
    #         proxy_pass http://api;
    #         # ... (ä¸Šè¨˜ã¨åŒã˜proxyè¨­å®š)
    #     }
    # }
}
```

---

### 3. CodePipeline CI/CDè¨­å®š

#### ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ§‹æˆ
```yaml
ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å: speedmatch-backend-pipeline
ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚¿ã‚¤ãƒ—: V2

ã‚¹ãƒ†ãƒ¼ã‚¸:
  1. Source: GitHub
  2. Build: CodeBuild
  3. Deploy: EC2 (SSHçµŒç”±)

ã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«: AWSCodePipelineServiceRole
```

#### Source ã‚¹ãƒ†ãƒ¼ã‚¸
```yaml
ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å: Source
ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼: GitHub (Version 2)

æ¥ç¶š:
  æ¥ç¶šå: github-connection
  ãƒªãƒã‚¸ãƒˆãƒª: your-org/speedmatch-backend
  ãƒ–ãƒ©ãƒ³ãƒ: main

æ¤œå‡ºã‚ªãƒ—ã‚·ãƒ§ãƒ³:
  - ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã«è‡ªå‹•å®Ÿè¡Œ

å‡ºåŠ›ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ: SourceArtifact
```

#### Build ã‚¹ãƒ†ãƒ¼ã‚¸ï¼ˆCodeBuildï¼‰
```yaml
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå: speedmatch-backend-build
èª¬æ˜: Build and prepare deployment package

ç’°å¢ƒ:
  ã‚¿ã‚¤ãƒ—: Linux
  ã‚¤ãƒ¡ãƒ¼ã‚¸: aws/codebuild/standard:7.0
  ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒˆ: BUILD_GENERAL1_SMALL
  ç‰¹æ¨©ãƒ¢ãƒ¼ãƒ‰: ç„¡åŠ¹ï¼ˆDockerãƒ“ãƒ«ãƒ‰ä¸è¦ï¼‰

ç’°å¢ƒå¤‰æ•°:
  - EC2_HOST: (EC2ã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯IP)
  - EC2_USER: ec2-user
  - DEPLOY_PATH: /home/ec2-user/speedmatch

ã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«: codebuild-speedmatch-backend-build-service-role

ãƒ“ãƒ«ãƒ‰ä»•æ§˜: buildspec.ymlï¼ˆãƒªãƒã‚¸ãƒˆãƒªå†…ï¼‰
```

#### buildspec.yml
```yaml
version: 0.2

phases:
  install:
    runtime-versions:
      nodejs: 18
    commands:
      - echo Installing dependencies...
      - npm install --production
  
  pre_build:
    commands:
      - echo Setting up SSH...
      - mkdir -p ~/.ssh
      - echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
      - chmod 600 ~/.ssh/deploy_key
      - ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts
  
  build:
    commands:
      - echo Build started on `date`
      - echo Creating deployment package...
      - tar -czf deployment.tar.gz \
          package*.json \
          src/ \
          Dockerfile \
          docker-compose.yml \
          nginx/ \
          init.sql \
          deploy.sh
  
  post_build:
    commands:
      - echo Build completed on `date`
      - echo Deploying to EC2...
      - |
        scp -i ~/.ssh/deploy_key deployment.tar.gz $EC2_USER@$EC2_HOST:$DEPLOY_PATH/
      - |
        ssh -i ~/.ssh/deploy_key $EC2_USER@$EC2_HOST << 'ENDSSH'
          cd /home/ec2-user/speedmatch
          tar -xzf deployment.tar.gz
          chmod +x deploy.sh
          ./deploy.sh
        ENDSSH
      - echo Deployment completed!

artifacts:
  files:
    - '**/*'
```

#### deploy.shï¼ˆEC2ä¸Šã§å®Ÿè¡Œã•ã‚Œã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼‰
```bash
#!/bin/bash
set -e

echo "===== SpeedMatch Deployment Started ====="

# ç’°å¢ƒå¤‰æ•°èª­ã¿è¾¼ã¿
if [ -f .env ]; then
    export $(cat .env | xargs)
fi

# Docker Composeã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆåˆå›ã®ã¿ï¼‰
if [ ! -f /usr/local/bin/docker-compose ]; then
    echo "Installing Docker Compose..."
    sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
    sudo chmod +x /usr/local/bin/docker-compose
fi

# å¤ã„ã‚³ãƒ³ãƒ†ãƒŠåœæ­¢
echo "Stopping old containers..."
docker-compose down || true

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
# docker-compose run --rm api npm run migrate

# æ–°ã—ã„ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•
echo "Starting new containers..."
docker-compose up -d --build

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
echo "Waiting for services to be healthy..."
sleep 10

# APIãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
for i in {1..30}; do
    if curl -f http://localhost:3000/health > /dev/null 2>&1; then
        echo "API is healthy!"
        break
    fi
    echo "Waiting for API... ($i/30)"
    sleep 2
done

# ãƒ­ã‚°ç¢ºèª
echo "Recent logs:"
docker-compose logs --tail=20

# ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
echo "Cleaning up..."
docker system prune -f

echo "===== Deployment Completed Successfully ====="
```

#### CodeBuildã®IAMãƒãƒªã‚·ãƒ¼
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "logs:CreateLogGroup",
        "logs:CreateLogStream",
        "logs:PutLogEvents"
      ],
      "Resource": "*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:GetObjectVersion",
        "s3:PutObject"
      ],
      "Resource": "arn:aws:s3:::codepipeline-*/*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "secretsmanager:GetSecretValue"
      ],
      "Resource": "arn:aws:secretsmanager:*:*:secret:speedmatch/*"
    }
  ]
}
```

---

### 4. SSHéµã®ç®¡ç†ï¼ˆSecrets Managerï¼‰

#### SSHéµãƒšã‚¢ã®ä½œæˆã¨ä¿å­˜
```bash
# SSHéµãƒšã‚¢ç”Ÿæˆ
ssh-keygen -t rsa -b 4096 -f speedmatch-deploy-key -N ""

# EC2ã«å…¬é–‹éµã‚’è¿½åŠ 
cat speedmatch-deploy-key.pub >> ~/.ssh/authorized_keys

# Secrets Managerã«ç§˜å¯†éµã‚’ä¿å­˜
aws secretsmanager create-secret \
  --name speedmatch/ssh-private-key \
  --secret-string file://speedmatch-deploy-key \
  --description "SSH private key for CodeBuild to deploy to EC2"

# CodeBuildã®ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦è¨­å®š
# SSH_PRIVATE_KEY: speedmatch/ssh-private-key (Secrets Manager)
```

---

### 5. EC2åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

#### setup-ec2.sh
```bash
#!/bin/bash
set -e

echo "===== SpeedMatch EC2 Setup Script ====="

# ã‚·ã‚¹ãƒ†ãƒ æ›´æ–°
echo "Updating system..."
sudo yum update -y

# Docker ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
echo "Installing Docker..."
sudo yum install -y docker
sudo systemctl start docker
sudo systemctl enable docker
sudo usermod -a -G docker ec2-user

# Git ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
echo "Installing Git..."
sudo yum install -y git

# Node.js ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆç®¡ç†ç”¨ï¼‰
echo "Installing Node.js..."
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
nvm install 18
nvm use 18
nvm alias default 18

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
echo "Creating project directory..."
mkdir -p /home/ec2-user/speedmatch
cd /home/ec2-user/speedmatch

# åˆå›ã‚¯ãƒ­ãƒ¼ãƒ³
echo "Cloning repository..."
git clone https://github.com/your-org/speedmatch-backend.git .

# ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
echo "Creating .env file..."
cat > .env << 'EOF'
DB_PASSWORD=CHANGE_THIS_PASSWORD
JWT_SECRET=CHANGE_THIS_SECRET
CORS_ORIGIN=*
NODE_ENV=production
PORT=3000
EOF

echo "Please edit .env file with your secure values:"
echo "nano .env"

# Docker Compose ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
echo "Installing Docker Compose..."
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«è¨­å®šï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
# sudo firewall-cmd --permanent --add-service=http
# sudo firewall-cmd --permanent --add-service=https
# sudo firewall-cmd --reload

echo "===== Setup Completed ====="
echo ""
echo "Next steps:"
echo "1. Edit .env file: nano /home/ec2-user/speedmatch/.env"
echo "2. Start services: cd /home/ec2-user/speedmatch && docker-compose up -d"
echo "3. Check logs: docker-compose logs -f"
echo ""
echo "You may need to log out and log back in for Docker permissions to take effect."
```

---

## ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼

### åˆå›ãƒ‡ãƒ—ãƒ­ã‚¤
```bash
# 1. EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹èµ·å‹•
# AWS Console or CLI

# 2. SSHæ¥ç¶š
ssh -i speedmatch-key.pem ec2-user@<EC2-PUBLIC-IP>

# 3. ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
curl -o setup-ec2.sh https://raw.githubusercontent.com/your-org/speedmatch-backend/main/setup-ec2.sh
chmod +x setup-ec2.sh
./setup-ec2.sh

# 4. ç’°å¢ƒå¤‰æ•°è¨­å®š
cd /home/ec2-user/speedmatch
nano .env  # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’å¤‰æ›´

# 5. åˆå›èµ·å‹•
docker-compose up -d

# 6. ç¢ºèª
curl http://localhost:3000/health
docker-compose logs -f
```

### é€šå¸¸ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆè‡ªå‹•ï¼‰
```bash
# GitHubã«ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹ã ã‘
git add .
git commit -m "Update API"
git push origin main

# CodePipelineãŒè‡ªå‹•å®Ÿè¡Œ:
# 1. GitHub ã‹ã‚‰æœ€æ–°ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
# 2. CodeBuild ã§ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä½œæˆ
# 3. SSHçµŒç”±ã§EC2ã«ãƒ‡ãƒ—ãƒ­ã‚¤
# 4. docker-compose down && up -d --build
```

### æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆç·Šæ€¥æ™‚ï¼‰
```bash
# EC2ã«SSHæ¥ç¶š
ssh -i speedmatch-key.pem ec2-user@<EC2-PUBLIC-IP>

# æœ€æ–°ã‚³ãƒ¼ãƒ‰å–å¾—
cd /home/ec2-user/speedmatch
git pull origin main

# å†èµ·å‹•
docker-compose down
docker-compose up -d --build

# ãƒ­ã‚°ç¢ºèª
docker-compose logs -f api
```

---

## ğŸ’° æœ€çµ‚ã‚³ã‚¹ãƒˆ

| ã‚µãƒ¼ãƒ“ã‚¹ | ä»•æ§˜ | æœˆé¡ |
|---------|------|------|
| EC2 t3.micro | 1å°ã€24æ™‚é–“ç¨¼åƒ | $0ï¼ˆç„¡æ–™æ 750æ™‚é–“ï¼‰ |
| EBS 30GB | gp3 | $0ï¼ˆç„¡æ–™æ 30GBï¼‰ |
| S3 | 5GBä»¥ä¸‹ | $0ï¼ˆç„¡æ–™æ ï¼‰ |
| ãƒ‡ãƒ¼ã‚¿è»¢é€ | 15GBä»¥ä¸‹ | $0ï¼ˆç„¡æ–™æ ï¼‰ |
| CodePipeline | 1ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ | $0ï¼ˆç„¡æ–™æ ï¼‰ |
| CodeBuild | 100åˆ†ä»¥ä¸‹/æœˆ | $0ï¼ˆç„¡æ–™æ ï¼‰ |
| **åˆè¨ˆ** | | **$0/æœˆ** âœ¨ |

**ç„¡æ–™æ çµ‚äº†å¾Œï¼ˆ12ãƒ¶æœˆå¾Œï¼‰:**
- EC2: $7.5/æœˆ
- ãã®ä»–: $2/æœˆ
- åˆè¨ˆ: **$9.5/æœˆ**

---

## ğŸ“Š ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

### CloudWatchè¨­å®š
```bash
# CloudWatch Agentã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
sudo yum install -y amazon-cloudwatch-agent

# ãƒ¡ãƒˆãƒªã‚¯ã‚¹è‡ªå‹•é€ä¿¡
# - CPUä½¿ç”¨ç‡
# - ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡
# - ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡
```

### ãƒ­ã‚°ç¢ºèª
```bash
# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°
docker-compose logs -f api

# Nginxãƒ­ã‚°
docker-compose logs -f nginx

# PostgreSQLãƒ­ã‚°
docker-compose logs -f postgres

# ã™ã¹ã¦ã®ãƒ­ã‚°
docker-compose logs -f
```

---

## ğŸ”§ é‹ç”¨Tips

### ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
```bash
# PostgreSQLãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
docker-compose exec postgres pg_dump -U admin speedmatch > backup_$(date +%Y%m%d).sql

# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’S3ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
aws s3 cp backup_$(date +%Y%m%d).sql s3://speedmatch-backups/

# cronã§è‡ªå‹•åŒ–
0 2 * * * /home/ec2-user/speedmatch/backup.sh
```

### ãƒªã‚¹ãƒˆã‚¢
```bash
# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰ãƒªã‚¹ãƒˆã‚¢
docker-compose exec -T postgres psql -U admin speedmatch < backup_20251011.sql
```

### ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
```bash
# ã‚³ãƒ³ãƒ†ãƒŠçŠ¶æ…‹ç¢ºèª
docker-compose ps

# ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨çŠ¶æ³
docker stats

# ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç¢ºèª
docker network ls
docker network inspect speedmatch_speedmatch-network

# å®Œå…¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆæ³¨æ„ï¼ï¼‰
docker-compose down -v  # ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚‚å‰Šé™¤
docker system prune -a -f
```

ã“ã®æ§‹æˆã§é€²ã‚ã¾ã—ã‚‡ã†ï¼æ¬¡ã¯å…·ä½“çš„ãªã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ# ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒãƒƒãƒ è¶…ä½ã‚³ã‚¹ãƒˆé–‹ç™ºç”¨æ§‹æˆï¼ˆAWSï¼‰

## ğŸ¯ ç›®æ¨™: æœˆé¡ $0-5 ã§AWSãƒ•ãƒ«æ´»ç”¨

---

## ğŸ—ï¸ æœ€å°ã‚³ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Internet                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   S3 (é™çš„ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°) â”‚ â† ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ (React)
          â”‚   + CloudFront (ä»»æ„)  â”‚    æœˆé¡ $0-2
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â†“ API Request
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   EC2 t3.micro         â”‚ â† ç„¡æ–™æ : 750æ™‚é–“/æœˆï¼ˆ1å°ãªã‚‰å®Œå…¨ç„¡æ–™ï¼‰
          â”‚   (1GB RAM, 2 vCPU)    â”‚    Dockerç›´æ¥å®Ÿè¡Œï¼ˆECSä¸è¦ï¼‰
          â”‚                        â”‚
          â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
          â”‚   â”‚ Node.js API    â”‚   â”‚
          â”‚   â”‚ + PostgreSQL   â”‚   â”‚ â† åŒä¸€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä¸Š
          â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â†“ (ä»»æ„)
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   RDS db.t3.micro      â”‚ â† ç„¡æ–™æ : 750æ™‚é–“/æœˆ
          â”‚   PostgreSQL 15        â”‚    20GB ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç„¡æ–™
          â”‚   (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)         â”‚    æœˆé¡ $0
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’° AWS ç„¡æ–™æ ã®è©³ç´°

### 12ãƒ¶æœˆé–“ç„¡æ–™ï¼ˆæ–°è¦ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼‰
```yaml
EC2:
  - t2.micro or t3.micro: 750æ™‚é–“/æœˆï¼ˆ1å°å¸¸æ™‚ç¨¼åƒå¯èƒ½ï¼‰
  - 30GB EBSã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼ˆgp2 or gp3ï¼‰
  - 15GB ãƒ‡ãƒ¼ã‚¿è»¢é€ï¼ˆã‚¢ã‚¦ãƒˆï¼‰

RDS:
  - db.t2.micro or db.t3.micro: 750æ™‚é–“/æœˆ
  - 20GB ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼ˆgp2 or gp3ï¼‰
  - 20GB ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸

S3:
  - 5GB æ¨™æº–ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
  - 20,000 GETãƒªã‚¯ã‚¨ã‚¹ãƒˆ
  - 2,000 PUTãƒªã‚¯ã‚¨ã‚¹ãƒˆ

CloudWatch:
  - 10ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹
  - 10ã‚¢ãƒ©ãƒ¼ãƒ 
  - 1,000,000 API ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

ãƒ‡ãƒ¼ã‚¿è»¢é€:
  - 100GB/æœˆï¼ˆCloudFrontï¼‰
  - 15GB/æœˆï¼ˆEC2ï¼‰
```

### æ°¸ä¹…ç„¡æ–™
```yaml
CodePipeline:
  - 1ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³/æœˆ

CodeBuild:
  - 100ãƒ“ãƒ«ãƒ‰åˆ†/æœˆï¼ˆsmall: 1åˆ† = 0.005USDï¼‰

Lambda:
  - 100ä¸‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/æœˆ
  - 400,000 GBç§’/æœˆ

CloudWatch Logs:
  - 5GB ã‚¤ãƒ³ã‚¸ã‚§ã‚¹ãƒˆ
  - 5GB ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–

AWS CodeCommit:
  - 5ãƒ¦ãƒ¼ã‚¶ãƒ¼
  - 50GB ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸/æœˆ
```

---

## ğŸ¯ æ¨å¥¨æ§‹æˆ: EC2 å˜ç‹¬é‹ç”¨ï¼ˆæœˆé¡ $0-3ï¼‰

### æ§‹æˆè©³ç´°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   EC2 t3.micro (Amazon Linux 2023)     â”‚
â”‚   - 1GB RAM, 2 vCPU                    â”‚
â”‚   - 30GB EBS (gp3)                     â”‚
â”‚                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ Docker Compose                  â”‚  â”‚
â”‚   â”‚                                 â”‚  â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚   â”‚  â”‚ Node.js  â”‚  â”‚ PostgreSQL â”‚  â”‚  â”‚
â”‚   â”‚  â”‚ API      â”‚  â”‚ 15.x       â”‚  â”‚  â”‚
â”‚   â”‚  â”‚ Port:3000â”‚  â”‚ Port:5432  â”‚  â”‚  â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚   â”‚                                 â”‚  â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚   â”‚  â”‚ Nginx (ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·) â”‚  â”‚  â”‚
â”‚   â”‚  â”‚ Port: 80, 443            â”‚  â”‚  â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                         â”‚
â”‚   ç„¡æ–™æ ã§å®Œå…¨ã‚«ãƒãƒ¼: $0/æœˆ            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ è©³ç´°è¨­å®š

### 1. EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹è¨­å®š

#### ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä»•æ§˜
```yaml
ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—: t3.micro
vCPU: 2
RAM: 1GB
ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯: æœ€å¤§5 Gbps

AMI: Amazon Linux 2023
EBS: 30GB gp3ï¼ˆç„¡æ–™æ ï¼‰
ãƒ‘ãƒ–ãƒªãƒƒã‚¯IP: æœ‰åŠ¹
Elastic IP: ç„¡åŠ¹ï¼ˆæœˆé¡$3.6ã‹ã‹ã‚‹ãŸã‚ï¼‰

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—:
  ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰:
    - SSH (22): ãƒã‚¤IP
    - HTTP (80): 0.0.0.0/0
    - HTTPS (443): 0.0.0.0/0
    - API (3000): 0.0.0.0/0ï¼ˆé–‹ç™ºç”¨ã€æœ¬ç•ªã§ã¯80/443ã®ã¿ï¼‰
  
  ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰:
    - All: 0.0.0.0/0

ã‚³ã‚¹ãƒˆ: $0ï¼ˆç„¡æ–™æ å†…ï¼‰
```

#### ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹èµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
```bash
#!/bin/bash

# ã‚·ã‚¹ãƒ†ãƒ æ›´æ–°
sudo yum update -y

# Docker ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
sudo yum install -y docker
sudo systemctl start docker
sudo systemctl enable docker
sudo usermod -a -G docker ec2-user

# Docker Compose ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# Git ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
sudo yum install -y git

# Node.js ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆç®¡ç†ç”¨ï¼‰
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 18
nvm use 18
```

---

### 2. Docker Compose æ§‹æˆ

#### docker-compose.yml
```yaml
version: '3.8'

services:
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - api
    restart: unless-stopped
    mem_limit: 128m

  api:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=speedmatch
      - DB_USER=admin
      - DB_PASSWORD=${DB_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      - postgres
    restart: unless-stopped
    mem_limit: 512m

  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=speedmatch
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    mem_limit: 256m
    command: 
      - "postgres"
      - "-c"
      - "max_connections=50"
      - "-c"
      - "shared_buffers=128MB"

volumes:
  postgres_data:
```

**ãƒ¡ãƒ¢ãƒªé…åˆ†:**
- Nginx: 128MB
- API: 512MB
- PostgreSQL: 256MB
- ã‚·ã‚¹ãƒ†ãƒ : 100MB
- åˆè¨ˆ: ç´„1GBï¼ˆã‚®ãƒªã‚®ãƒªã ãŒå‹•ä½œå¯èƒ½ï¼‰

#### nginx.conf
```nginx
events {
    worker_connections 1024;
}

http {
    upstream api {
        server api:3000;
    }

    # HTTP â†’ HTTPS ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆSSLè¨­å®šæ™‚ï¼‰
    server {
        listen 80;
        server_name _;
        return 301 https://$host$request_uri;
    }

    # API ã‚µãƒ¼ãƒãƒ¼
    server {
        listen 443 ssl;
        server_name api.yourdomain.com;

        # è‡ªå·±ç½²åè¨¼æ˜æ›¸ï¼ˆLet's Encryptæ¨å¥¨ï¼‰
        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;

        location / {
            proxy_pass http://api;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
        location /health {
            proxy_pass http://api/health;
            access_log off;
        }
    }
}
```

---

### 3. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ (S3 é™çš„ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°)

#### S3è¨­å®š
```yaml
ãƒã‚±ãƒƒãƒˆå: speedmatch-frontend-[random]
ãƒªãƒ¼ã‚¸ãƒ§ãƒ³: ap-northeast-1

é™çš„ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°:
  æœ‰åŠ¹: ã¯ã„
  ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: index.html
  ã‚¨ãƒ©ãƒ¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: index.html

ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹:
  - ãƒ–ãƒ­ãƒƒã‚¯ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹: ã‚ªãƒ•ï¼ˆé™çš„ã‚µã‚¤ãƒˆç”¨ï¼‰
  
ãƒã‚±ãƒƒãƒˆãƒãƒªã‚·ãƒ¼:
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "PublicReadGetObject",
      "Effect": "Allow",
      "Principal": "*",
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::speedmatch-frontend-*/*"
    }
  ]
}

ã‚³ã‚¹ãƒˆ: $0-1/æœˆï¼ˆ5GBç„¡æ–™æ å†…ï¼‰
```

#### ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
```bash
#!/bin/bash
# deploy-frontend.sh

# ãƒ“ãƒ«ãƒ‰
npm run build

# S3ã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
aws s3 sync dist/ s3://speedmatch-frontend-xxx/ --delete

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ï¼ˆCloudFrontä½¿ç”¨æ™‚ï¼‰
# aws cloudfront create-invalidation --distribution-id XXX --paths "/*"

echo "ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ï¼"
echo "URL: http://speedmatch-frontend-xxx.s3-website-ap-northeast-1.amazonaws.com"
```

---

### 4. CI/CD (CodePipeline + CodeBuild)

#### buildspec.yml
```yaml
version: 0.2

phases:
  pre_build:
    commands:
      - echo Logging in to EC2...
      
  build:
    commands:
      - echo Build started on `date`
      - echo Building Docker image...
      - docker build -t speedmatch-api .
      
  post_build:
    commands:
      - echo Build completed on `date`
      - echo Deploying to EC2...
      # SSHã§EC2ã«æ¥ç¶šã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤
      - |
        ssh -o StrictHostKeyChecking=no ec2-user@$EC2_HOST << 'EOF'
          cd /home/ec2-user/speedmatch-backend
          git pull origin main
          docker-compose down
          docker-compose up -d --build
        EOF

artifacts:
  files:
    - '**/*'
```

#### CodePipelineè¨­å®šï¼ˆç„¡æ–™ï¼‰
```yaml
ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å: speedmatch-pipeline
ã‚¹ãƒ†ãƒ¼ã‚¸:
  1. Source: GitHub
  2. Build: CodeBuild (ç„¡æ–™æ : 100åˆ†/æœˆ)
  3. Deploy: ã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆSSHçµŒç”±ï¼‰

ã‚³ã‚¹ãƒˆ: $0ï¼ˆ1ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ç„¡æ–™ï¼‰
```

---

## ğŸ”§ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †

### Step 1: EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹èµ·å‹•
```bash
# AWS CLIã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹èµ·å‹•
aws ec2 run-instances \
  --image-id ami-0d48337b7d3c86f62 \  # Amazon Linux 2023
  --instance-type t3.micro \
  --key-name your-key-pair \
  --security-group-ids sg-xxxxx \
  --subnet-id subnet-xxxxx \
  --user-data file://user-data.sh \
  --tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=speedmatch-server}]'
```

### Step 2: EC2ã«æ¥ç¶šã—ã¦ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
```bash
# SSHæ¥ç¶š
ssh -i your-key.pem ec2-user@ec2-xx-xx-xx-xx.compute.amazonaws.com

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒ­ãƒ¼ãƒ³
git clone https://github.com/your-org/speedmatch-backend.git
cd speedmatch-backend

# ç’°å¢ƒå¤‰æ•°è¨­å®š
cat > .env << EOF
DB_PASSWORD=your-secure-password
JWT_SECRET=your-jwt-secret
NODE_ENV=production
EOF

# Docker Composeèµ·å‹•
docker-compose up -d

# ãƒ­ã‚°ç¢ºèª
docker-compose logs -f
```

### Step 3: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤
```bash
# S3ãƒã‚±ãƒƒãƒˆä½œæˆ
aws s3 mb s3://speedmatch-frontend-12345

# é™çš„ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°æœ‰åŠ¹åŒ–
aws s3 website s3://speedmatch-frontend-12345 \
  --index-document index.html \
  --error-document index.html

# ãƒ“ãƒ«ãƒ‰ï¼†ãƒ‡ãƒ—ãƒ­ã‚¤
cd speedmatch-frontend
npm run build
aws s3 sync dist/ s3://speedmatch-frontend-12345/ --delete
```

### Step 4: ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
```bash
# Route 53ãƒ›ã‚¹ãƒˆã‚¾ãƒ¼ãƒ³ä½œæˆï¼ˆ$0.50/æœˆï¼‰
aws route53 create-hosted-zone --name yourdomain.com --caller-reference $(date +%s)

# Aãƒ¬ã‚³ãƒ¼ãƒ‰è¿½åŠ 
# EC2ã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã‚’æŒ‡å®š
```

---

## ğŸ’¡ ã•ã‚‰ãªã‚‹ã‚³ã‚¹ãƒˆå‰Šæ¸›ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯

### 1. ã‚¹ãƒãƒƒãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åˆ©ç”¨ï¼ˆé–‹ç™ºç”¨ï¼‰
```yaml
# æœ€å¤§90%ã‚ªãƒ•ï¼ˆä¸­æ–­ãƒªã‚¹ã‚¯ã‚ã‚Šï¼‰
ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹è³¼å…¥ã‚ªãƒ—ã‚·ãƒ§ãƒ³: ã‚¹ãƒãƒƒãƒˆ
æœ€å¤§æ–™é‡‘: ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰ã®50%

ã‚³ã‚¹ãƒˆå‰Šæ¸›: æœˆé¡ $10 â†’ $1
â€» é–‹ç™ºç’°å¢ƒã®ã¿æ¨å¥¨
```

### 2. ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°
```bash
# å¤œé–“ãƒ»é€±æœ«åœæ­¢ï¼ˆ50%å‰Šæ¸›ï¼‰
# Lambda + EventBridge ã§è‡ªå‹•åŒ–

# åœæ­¢ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
# å¹³æ—¥: 21:00-9:00 åœæ­¢ï¼ˆ12æ™‚é–“ï¼‰
# é€±æœ«: å…¨åœæ­¢

# å®Ÿè³ªç¨¼åƒæ™‚é–“: æœˆ360æ™‚é–“ï¼ˆç„¡æ–™æ 750æ™‚é–“å†…ï¼‰
```

### 3. CloudFrontä¸ä½¿ç”¨
```yaml
# S3ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã§$0
# é€Ÿåº¦ã¯å¤šå°‘è½ã¡ã‚‹ãŒè¨±å®¹ç¯„å›²

S3 Website Endpoint:
  http://bucket-name.s3-website-region.amazonaws.com
  
ã‚³ã‚¹ãƒˆ: $0
```

### 4. RDSä¸ä½¿ç”¨ï¼ˆEC2å†…PostgreSQLï¼‰
```yaml
# RDS 750æ™‚é–“/æœˆã¯1å°ã®ã¿ç„¡æ–™
# EC2å†…ã§PostgreSQLç¨¼åƒã•ã›ã¦å®Œå…¨ç„¡æ–™åŒ–

ãƒ¡ãƒªãƒƒãƒˆ: $0
ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ: 
  - ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯æ‰‹å‹•
  - ã‚¹ã‚±ãƒ¼ãƒ«ã—ã«ãã„
  
é–‹ç™ºç”¨ã«ã¯ååˆ†
```

### 5. Elastic IPä¸ä½¿ç”¨
```yaml
# ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã¯ç„¡æ–™
# Elastic IPã¯æœˆé¡ $3.6

å¯¾ç­–:
  - Dynamic DNSã‚µãƒ¼ãƒ“ã‚¹åˆ©ç”¨ï¼ˆç„¡æ–™ï¼‰
  - ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPå¤‰æ›´æ™‚ã«DNSæ›´æ–°

ã‚³ã‚¹ãƒˆå‰Šæ¸›: $3.6/æœˆ
```

---

## ğŸ“Š æœ€çµ‚ã‚³ã‚¹ãƒˆè¦‹ç©ã‚‚ã‚Š

### ãƒ‘ã‚¿ãƒ¼ãƒ³A: å®Œå…¨ç„¡æ–™æ§‹æˆï¼ˆç„¡æ–™æ å†…ï¼‰
```
EC2 t3.micro: $0ï¼ˆ750æ™‚é–“ç„¡æ–™ï¼‰
S3: $0ï¼ˆ5GBç„¡æ–™ï¼‰
ãƒ‡ãƒ¼ã‚¿è»¢é€: $0ï¼ˆ15GBç„¡æ–™ï¼‰
CodePipeline: $0ï¼ˆ1ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ç„¡æ–™ï¼‰
CodeBuild: $0ï¼ˆ100åˆ†ç„¡æ–™ï¼‰

åˆè¨ˆ: $0/æœˆ âœ¨
```

### ãƒ‘ã‚¿ãƒ¼ãƒ³B: æœ€å°ã‚³ã‚¹ãƒˆæ§‹æˆ
```
EC2 t3.micro: $0ï¼ˆç„¡æ–™æ ï¼‰
RDS db.t3.micro: $0ï¼ˆç„¡æ–™æ ï¼‰
S3: $0ï¼ˆç„¡æ–™æ å†…ï¼‰
Route53: $0.50ï¼ˆãƒ›ã‚¹ãƒˆã‚¾ãƒ¼ãƒ³ï¼‰
ãƒ‡ãƒ¼ã‚¿è»¢é€è¶…éåˆ†: $1-2

åˆè¨ˆ: $1.5-3/æœˆ
```

### ãƒ‘ã‚¿ãƒ¼ãƒ³C: 24æ™‚é–“ç¨¼åƒï¼ˆç„¡æ–™æ å¾Œï¼‰
```
EC2 t3.micro: $7.5
S3: $1
ãƒ‡ãƒ¼ã‚¿è»¢é€: $2
Route53: $0.50

åˆè¨ˆ: $11/æœˆ
```

---

## ğŸ¯ æ¨å¥¨æ§‹æˆã¾ã¨ã‚

### é–‹ç™ºåˆæœŸï¼ˆ3-12ãƒ¶æœˆï¼‰
```
âœ… EC2 t3.micro 1å°ï¼ˆAPIã¨DBåŒå±…ï¼‰
âœ… S3 é™çš„ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°
âœ… ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPï¼ˆElastic IPä¸ä½¿ç”¨ï¼‰
âœ… CodePipeline 1ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
âœ… å¤œé–“åœæ­¢ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

æœˆé¡: $0-3
```

### ã“ã®æ§‹æˆã®åˆ©ç‚¹
1. âœ… **å®Œå…¨ã«AWSãƒã‚¤ãƒ†ã‚£ãƒ–** - æœ¬æ ¼çš„ãªæ§‹æˆ
2. âœ… **ã»ã¼ç„¡æ–™** - ç„¡æ–™æ ãƒ•ãƒ«æ´»ç”¨
3. âœ… **ã‚¹ã‚±ãƒ¼ãƒ«å¯èƒ½** - å¿…è¦ã«å¿œã˜ã¦æ‹¡å¼µ
4. âœ… **å­¦ç¿’ä¾¡å€¤é«˜ã„** - æœ¬ç•ªç’°å¢ƒã¨åŒã˜æŠ€è¡“

---

## ğŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ**ï¼ˆç„¡æ–™æ 12ãƒ¶æœˆï¼‰
2. **EC2èµ·å‹•**ï¼ˆt3.microï¼‰
3. **Docker Composeè¨­å®š**
4. **ã‚¢ãƒ—ãƒªãƒ‡ãƒ—ãƒ­ã‚¤**
5. **S3ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é…ä¿¡**

ã“ã®æ§‹æˆã§é€²ã‚ã¾ã—ã‚‡ã†ã‹ï¼Ÿ