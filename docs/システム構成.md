# スピードマッチ 最終システム構成

## 🏗️ システムアーキテクチャ（確定版）

```
┌─────────────────────────────────────────────────────────────┐
│                         Internet                            │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ↓
          ┌────────────────────────┐
          │   S3 静的ホスティング   │ ← フロントエンド (React)
          │   (バケットポリシー)    │    月額 $0-1
          └────────────────────────┘
                       │
                       ↓ API Request (直接)
          ┌────────────────────────────────────┐
          │   EC2 t3.micro (Amazon Linux 2023)│
          │   Public IP: xx.xx.xx.xx          │
          │   月額 $0 (無料枠)                 │
          │                                    │
          │  ┌──────────────────────────────┐ │
          │  │ Docker Compose               │ │
          │  │                              │ │
          │  │  ┌────────────────────────┐ │ │
          │  │  │ Nginx                  │ │ │
          │  │  │ Port: 80, 443         │ │ │
          │  │  │ (リバースプロキシ)     │ │ │
          │  │  └────────────────────────┘ │ │
          │  │           ↓                 │ │
          │  │  ┌────────────────────────┐ │ │
          │  │  │ Node.js API Server     │ │ │
          │  │  │ Port: 3000            │ │ │
          │  │  │ Express + PostgreSQL  │ │ │
          │  │  └────────────────────────┘ │ │
          │  │           ↓                 │ │
          │  │  ┌────────────────────────┐ │ │
          │  │  │ PostgreSQL 15          │ │ │
          │  │  │ Port: 5432            │ │ │
          │  │  │ Data: /postgres_data  │ │ │
          │  │  └────────────────────────┘ │ │
          │  └──────────────────────────────┘ │
          └────────────────────────────────────┘
                       ↑
                       │ SSH Deploy
          ┌────────────────────────┐
          │   AWS CodePipeline     │
          │                        │
          │  GitHub → CodeBuild →  │
          │  SSH Deploy to EC2     │
          │                        │
          │  月額 $0 (1パイプライン)│
          └────────────────────────┘
```

---

## 📋 構成要素の詳細

### 1. EC2インスタンス（すべてをここに集約）

#### インスタンス仕様
```yaml
名前: speedmatch-server
インスタンスタイプ: t3.micro
  - vCPU: 2
  - RAM: 1GB
  - ネットワーク: 最大5 Gbps

AMI: Amazon Linux 2023 (最新)
EBS: 30GB gp3（無料枠）

ネットワーク:
  - VPC: デフォルトVPC
  - サブネット: パブリックサブネット
  - パブリックIP: 自動割り当て
  - Elastic IP: 不使用（コスト削減）

キーペア: speedmatch-key.pem

タグ:
  Name: speedmatch-server
  Environment: development
  Project: speedmatch

コスト: $0/月（無料枠750時間）
```

#### セキュリティグループ
```yaml
名前: speedmatch-sg
説明: Security group for SpeedMatch server

インバウンドルール:
  - Type: SSH
    Protocol: TCP
    Port: 22
    Source: マイIP/32
    説明: 管理用SSH（セキュアな接続元のみ）
  
  - Type: HTTP
    Protocol: TCP
    Port: 80
    Source: 0.0.0.0/0
    説明: HTTPアクセス
  
  - Type: HTTPS
    Protocol: TCP
    Port: 443
    Source: 0.0.0.0/0
    説明: HTTPSアクセス
  
  - Type: Custom TCP
    Protocol: TCP
    Port: 3000
    Source: 0.0.0.0/0
    説明: API直接アクセス（開発用、本番では削除推奨）

アウトバウンドルール:
  - Type: All traffic
    Protocol: All
    Port: All
    Destination: 0.0.0.0/0
```

#### IAM ロール
```yaml
ロール名: speedmatch-ec2-role

ポリシー:
  - AmazonSSMManagedInstanceCore（Systems Manager用）
  - カスタムポリシー（S3, Secrets Manager）

カスタムポリシー:
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:PutObject"
      ],
      "Resource": "arn:aws:s3:::speedmatch-*/*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "secretsmanager:GetSecretValue"
      ],
      "Resource": "arn:aws:secretsmanager:*:*:secret:speedmatch/*"
    }
  ]
}
```

---

### 2. Docker Compose 構成

#### ディレクトリ構造
```
/home/ec2-user/speedmatch/
├── docker-compose.yml
├── .env
├── api/
│   ├── Dockerfile
│   ├── package.json
│   ├── src/
│   └── ...
├── nginx/
│   ├── nginx.conf
│   └── ssl/
│       ├── cert.pem
│       └── key.pem
└── postgres_data/（Docker volume）
```

#### docker-compose.yml
```yaml
version: '3.8'

services:
  nginx:
    image: nginx:alpine
    container_name: speedmatch-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - api
    restart: unless-stopped
    networks:
      - speedmatch-network
    mem_limit: 128m
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  api:
    build: ./api
    container_name: speedmatch-api
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=speedmatch
      - DB_USER=admin
      - DB_PASSWORD=${DB_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
      - CORS_ORIGIN=${CORS_ORIGIN}
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - speedmatch-network
    mem_limit: 512m
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  postgres:
    image: postgres:15-alpine
    container_name: speedmatch-postgres
    environment:
      - POSTGRES_DB=speedmatch
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --locale=C
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    restart: unless-stopped
    networks:
      - speedmatch-network
    mem_limit: 256m
    command:
      - "postgres"
      - "-c"
      - "max_connections=50"
      - "-c"
      - "shared_buffers=128MB"
      - "-c"
      - "effective_cache_size=256MB"
      - "-c"
      - "maintenance_work_mem=64MB"
      - "-c"
      - "checkpoint_completion_target=0.9"
      - "-c"
      - "wal_buffers=4MB"
      - "-c"
      - "default_statistics_target=100"
      - "-c"
      - "random_page_cost=1.1"
      - "-c"
      - "effective_io_concurrency=200"
      - "-c"
      - "work_mem=2621kB"
      - "-c"
      - "min_wal_size=1GB"
      - "-c"
      - "max_wal_size=4GB"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d speedmatch"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  speedmatch-network:
    driver: bridge

volumes:
  postgres_data:
    driver: local
```

#### .env（環境変数）
```bash
# Database
DB_PASSWORD=your_secure_password_here_change_me

# JWT
JWT_SECRET=your_jwt_secret_key_change_me

# CORS
CORS_ORIGIN=http://speedmatch-frontend.s3-website-ap-northeast-1.amazonaws.com

# App
NODE_ENV=production
PORT=3000
```

#### nginx/nginx.conf
```nginx
events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # ログ設定
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # 基本設定
    sendfile on;
    keepalive_timeout 65;
    client_max_body_size 10M;

    # gzip圧縮
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    upstream api {
        server api:3000;
    }

    # HTTPサーバー
    server {
        listen 80;
        server_name _;

        # ヘルスチェック
        location /health {
            proxy_pass http://api/health;
            access_log off;
        }

        # APIプロキシ
        location / {
            proxy_pass http://api;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # CORS設定（必要に応じて）
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization' always;

            if ($request_method = 'OPTIONS') {
                return 204;
            }

            # タイムアウト設定
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }
    }

    # HTTPSサーバー（SSL証明書設定時）
    # server {
    #     listen 443 ssl;
    #     server_name api.yourdomain.com;
    #
    #     ssl_certificate /etc/nginx/ssl/cert.pem;
    #     ssl_certificate_key /etc/nginx/ssl/key.pem;
    #
    #     location / {
    #         proxy_pass http://api;
    #         # ... (上記と同じproxy設定)
    #     }
    # }
}
```

---

### 3. CodePipeline CI/CD設定

#### パイプライン構成
```yaml
パイプライン名: speedmatch-backend-pipeline
パイプラインタイプ: V2

ステージ:
  1. Source: GitHub
  2. Build: CodeBuild
  3. Deploy: EC2 (SSH経由)

サービスロール: AWSCodePipelineServiceRole
```

#### Source ステージ
```yaml
アクション名: Source
プロバイダー: GitHub (Version 2)

接続:
  接続名: github-connection
  リポジトリ: your-org/speedmatch-backend
  ブランチ: main

検出オプション:
  - プッシュ時に自動実行

出力アーティファクト: SourceArtifact
```

#### Build ステージ（CodeBuild）
```yaml
プロジェクト名: speedmatch-backend-build
説明: Build and prepare deployment package

環境:
  タイプ: Linux
  イメージ: aws/codebuild/standard:7.0
  コンピュート: BUILD_GENERAL1_SMALL
  特権モード: 無効（Dockerビルド不要）

環境変数:
  - EC2_HOST: (EC2のパブリックIP)
  - EC2_USER: ec2-user
  - DEPLOY_PATH: /home/ec2-user/speedmatch

サービスロール: codebuild-speedmatch-backend-build-service-role

ビルド仕様: buildspec.yml（リポジトリ内）
```

#### buildspec.yml
```yaml
version: 0.2

phases:
  install:
    runtime-versions:
      nodejs: 18
    commands:
      - echo Installing dependencies...
      - npm install --production
  
  pre_build:
    commands:
      - echo Setting up SSH...
      - mkdir -p ~/.ssh
      - echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
      - chmod 600 ~/.ssh/deploy_key
      - ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts
  
  build:
    commands:
      - echo Build started on `date`
      - echo Creating deployment package...
      - tar -czf deployment.tar.gz \
          package*.json \
          src/ \
          Dockerfile \
          docker-compose.yml \
          nginx/ \
          init.sql \
          deploy.sh
  
  post_build:
    commands:
      - echo Build completed on `date`
      - echo Deploying to EC2...
      - |
        scp -i ~/.ssh/deploy_key deployment.tar.gz $EC2_USER@$EC2_HOST:$DEPLOY_PATH/
      - |
        ssh -i ~/.ssh/deploy_key $EC2_USER@$EC2_HOST << 'ENDSSH'
          cd /home/ec2-user/speedmatch
          tar -xzf deployment.tar.gz
          chmod +x deploy.sh
          ./deploy.sh
        ENDSSH
      - echo Deployment completed!

artifacts:
  files:
    - '**/*'
```

#### deploy.sh（EC2上で実行されるスクリプト）
```bash
#!/bin/bash
set -e

echo "===== SpeedMatch Deployment Started ====="

# 環境変数読み込み
if [ -f .env ]; then
    export $(cat .env | xargs)
fi

# Docker Composeのダウンロード（初回のみ）
if [ ! -f /usr/local/bin/docker-compose ]; then
    echo "Installing Docker Compose..."
    sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
    sudo chmod +x /usr/local/bin/docker-compose
fi

# 古いコンテナ停止
echo "Stopping old containers..."
docker-compose down || true

# データベースマイグレーション（必要に応じて）
# docker-compose run --rm api npm run migrate

# 新しいコンテナ起動
echo "Starting new containers..."
docker-compose up -d --build

# ヘルスチェック
echo "Waiting for services to be healthy..."
sleep 10

# APIヘルスチェック
for i in {1..30}; do
    if curl -f http://localhost:3000/health > /dev/null 2>&1; then
        echo "API is healthy!"
        break
    fi
    echo "Waiting for API... ($i/30)"
    sleep 2
done

# ログ確認
echo "Recent logs:"
docker-compose logs --tail=20

# クリーンアップ
echo "Cleaning up..."
docker system prune -f

echo "===== Deployment Completed Successfully ====="
```

#### CodeBuildのIAMポリシー
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "logs:CreateLogGroup",
        "logs:CreateLogStream",
        "logs:PutLogEvents"
      ],
      "Resource": "*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:GetObjectVersion",
        "s3:PutObject"
      ],
      "Resource": "arn:aws:s3:::codepipeline-*/*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "secretsmanager:GetSecretValue"
      ],
      "Resource": "arn:aws:secretsmanager:*:*:secret:speedmatch/*"
    }
  ]
}
```

---

### 4. SSH鍵の管理（Secrets Manager）

#### SSH鍵ペアの作成と保存
```bash
# SSH鍵ペア生成
ssh-keygen -t rsa -b 4096 -f speedmatch-deploy-key -N ""

# EC2に公開鍵を追加
cat speedmatch-deploy-key.pub >> ~/.ssh/authorized_keys

# Secrets Managerに秘密鍵を保存
aws secretsmanager create-secret \
  --name speedmatch/ssh-private-key \
  --secret-string file://speedmatch-deploy-key \
  --description "SSH private key for CodeBuild to deploy to EC2"

# CodeBuildの環境変数として設定
# SSH_PRIVATE_KEY: speedmatch/ssh-private-key (Secrets Manager)
```

---

### 5. EC2初期セットアップスクリプト

#### setup-ec2.sh
```bash
#!/bin/bash
set -e

echo "===== SpeedMatch EC2 Setup Script ====="

# システム更新
echo "Updating system..."
sudo yum update -y

# Docker インストール
echo "Installing Docker..."
sudo yum install -y docker
sudo systemctl start docker
sudo systemctl enable docker
sudo usermod -a -G docker ec2-user

# Git インストール
echo "Installing Git..."
sudo yum install -y git

# Node.js インストール（管理用）
echo "Installing Node.js..."
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
nvm install 18
nvm use 18
nvm alias default 18

# プロジェクトディレクトリ作成
echo "Creating project directory..."
mkdir -p /home/ec2-user/speedmatch
cd /home/ec2-user/speedmatch

# 初回クローン
echo "Cloning repository..."
git clone https://github.com/your-org/speedmatch-backend.git .

# 環境変数ファイル作成
echo "Creating .env file..."
cat > .env << 'EOF'
DB_PASSWORD=CHANGE_THIS_PASSWORD
JWT_SECRET=CHANGE_THIS_SECRET
CORS_ORIGIN=*
NODE_ENV=production
PORT=3000
EOF

echo "Please edit .env file with your secure values:"
echo "nano .env"

# Docker Compose インストール
echo "Installing Docker Compose..."
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# ファイアウォール設定（必要に応じて）
# sudo firewall-cmd --permanent --add-service=http
# sudo firewall-cmd --permanent --add-service=https
# sudo firewall-cmd --reload

echo "===== Setup Completed ====="
echo ""
echo "Next steps:"
echo "1. Edit .env file: nano /home/ec2-user/speedmatch/.env"
echo "2. Start services: cd /home/ec2-user/speedmatch && docker-compose up -d"
echo "3. Check logs: docker-compose logs -f"
echo ""
echo "You may need to log out and log back in for Docker permissions to take effect."
```

---

## 🚀 デプロイフロー

### 初回デプロイ
```bash
# 1. EC2インスタンス起動
# AWS Console or CLI

# 2. SSH接続
ssh -i speedmatch-key.pem ec2-user@<EC2-PUBLIC-IP>

# 3. セットアップスクリプト実行
curl -o setup-ec2.sh https://raw.githubusercontent.com/your-org/speedmatch-backend/main/setup-ec2.sh
chmod +x setup-ec2.sh
./setup-ec2.sh

# 4. 環境変数設定
cd /home/ec2-user/speedmatch
nano .env  # パスワードとシークレットを変更

# 5. 初回起動
docker-compose up -d

# 6. 確認
curl http://localhost:3000/health
docker-compose logs -f
```

### 通常デプロイ（自動）
```bash
# GitHubにプッシュするだけ
git add .
git commit -m "Update API"
git push origin main

# CodePipelineが自動実行:
# 1. GitHub から最新コードを取得
# 2. CodeBuild でビルド・パッケージ作成
# 3. SSH経由でEC2にデプロイ
# 4. docker-compose down && up -d --build
```

### 手動デプロイ（緊急時）
```bash
# EC2にSSH接続
ssh -i speedmatch-key.pem ec2-user@<EC2-PUBLIC-IP>

# 最新コード取得
cd /home/ec2-user/speedmatch
git pull origin main

# 再起動
docker-compose down
docker-compose up -d --build

# ログ確認
docker-compose logs -f api
```

---

## 💰 最終コスト

| サービス | 仕様 | 月額 |
|---------|------|------|
| EC2 t3.micro | 1台、24時間稼働 | $0（無料枠750時間） |
| EBS 30GB | gp3 | $0（無料枠30GB） |
| S3 | 5GB以下 | $0（無料枠） |
| データ転送 | 15GB以下 | $0（無料枠） |
| CodePipeline | 1パイプライン | $0（無料枠） |
| CodeBuild | 100分以下/月 | $0（無料枠） |
| **合計** | | **$0/月** ✨ |

**無料枠終了後（12ヶ月後）:**
- EC2: $7.5/月
- その他: $2/月
- 合計: **$9.5/月**

---

## 📊 モニタリング

### CloudWatch設定
```bash
# CloudWatch Agentインストール（オプション）
sudo yum install -y amazon-cloudwatch-agent

# メトリクス自動送信
# - CPU使用率
# - メモリ使用率
# - ディスク使用率
```

### ログ確認
```bash
# アプリケーションログ
docker-compose logs -f api

# Nginxログ
docker-compose logs -f nginx

# PostgreSQLログ
docker-compose logs -f postgres

# すべてのログ
docker-compose logs -f
```

---

## 🔧 運用Tips

### バックアップ
```bash
# PostgreSQLバックアップ
docker-compose exec postgres pg_dump -U admin speedmatch > backup_$(date +%Y%m%d).sql

# バックアップをS3にアップロード
aws s3 cp backup_$(date +%Y%m%d).sql s3://speedmatch-backups/

# cronで自動化
0 2 * * * /home/ec2-user/speedmatch/backup.sh
```

### リストア
```bash
# バックアップからリストア
docker-compose exec -T postgres psql -U admin speedmatch < backup_20251011.sql
```

### トラブルシューティング
```bash
# コンテナ状態確認
docker-compose ps

# リソース使用状況
docker stats

# ネットワーク確認
docker network ls
docker network inspect speedmatch_speedmatch-network

# 完全クリーンアップ（注意！）
docker-compose down -v  # ボリュームも削除
docker system prune -a -f
```

この構成で進めましょう！次は具体的なセットアップ手順を実行しますか？# スピードマッチ 超低コスト開発用構成（AWS）

## 🎯 目標: 月額 $0-5 でAWSフル活用

---

## 🏗️ 最小コストシステムアーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                         Internet                            │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ↓
          ┌────────────────────────┐
          │   S3 (静的ホスティング) │ ← フロントエンド (React)
          │   + CloudFront (任意)  │    月額 $0-2
          └────────────────────────┘
                       │
                       ↓ API Request
          ┌────────────────────────┐
          │   EC2 t3.micro         │ ← 無料枠: 750時間/月（1台なら完全無料）
          │   (1GB RAM, 2 vCPU)    │    Docker直接実行（ECS不要）
          │                        │
          │   ┌────────────────┐   │
          │   │ Node.js API    │   │
          │   │ + PostgreSQL   │   │ ← 同一インスタンス上
          │   └────────────────┘   │
          └────────────────────────┘
                       │
                       ↓ (任意)
          ┌────────────────────────┐
          │   RDS db.t3.micro      │ ← 無料枠: 750時間/月
          │   PostgreSQL 15        │    20GB ストレージ無料
          │   (オプション)         │    月額 $0
          └────────────────────────┘
```

---

## 💰 AWS 無料枠の詳細

### 12ヶ月間無料（新規アカウント）
```yaml
EC2:
  - t2.micro or t3.micro: 750時間/月（1台常時稼働可能）
  - 30GB EBSストレージ（gp2 or gp3）
  - 15GB データ転送（アウト）

RDS:
  - db.t2.micro or db.t3.micro: 750時間/月
  - 20GB ストレージ（gp2 or gp3）
  - 20GB バックアップストレージ

S3:
  - 5GB 標準ストレージ
  - 20,000 GETリクエスト
  - 2,000 PUTリクエスト

CloudWatch:
  - 10カスタムメトリクス
  - 10アラーム
  - 1,000,000 API リクエスト

データ転送:
  - 100GB/月（CloudFront）
  - 15GB/月（EC2）
```

### 永久無料
```yaml
CodePipeline:
  - 1パイプライン/月

CodeBuild:
  - 100ビルド分/月（small: 1分 = 0.005USD）

Lambda:
  - 100万リクエスト/月
  - 400,000 GB秒/月

CloudWatch Logs:
  - 5GB インジェスト
  - 5GB アーカイブ

AWS CodeCommit:
  - 5ユーザー
  - 50GB ストレージ/月
```

---

## 🎯 推奨構成: EC2 単独運用（月額 $0-3）

### 構成詳細

```
┌─────────────────────────────────────────┐
│   EC2 t3.micro (Amazon Linux 2023)     │
│   - 1GB RAM, 2 vCPU                    │
│   - 30GB EBS (gp3)                     │
│                                         │
│   ┌─────────────────────────────────┐  │
│   │ Docker Compose                  │  │
│   │                                 │  │
│   │  ┌──────────┐  ┌────────────┐  │  │
│   │  │ Node.js  │  │ PostgreSQL │  │  │
│   │  │ API      │  │ 15.x       │  │  │
│   │  │ Port:3000│  │ Port:5432  │  │  │
│   │  └──────────┘  └────────────┘  │  │
│   │                                 │  │
│   │  ┌──────────────────────────┐  │  │
│   │  │ Nginx (リバースプロキシ) │  │  │
│   │  │ Port: 80, 443            │  │  │
│   │  └──────────────────────────┘  │  │
│   └─────────────────────────────────┘  │
│                                         │
│   無料枠で完全カバー: $0/月            │
└─────────────────────────────────────────┘
```

---

## 📋 詳細設定

### 1. EC2インスタンス設定

#### インスタンス仕様
```yaml
インスタンスタイプ: t3.micro
vCPU: 2
RAM: 1GB
ネットワーク: 最大5 Gbps

AMI: Amazon Linux 2023
EBS: 30GB gp3（無料枠）
パブリックIP: 有効
Elastic IP: 無効（月額$3.6かかるため）

セキュリティグループ:
  インバウンド:
    - SSH (22): マイIP
    - HTTP (80): 0.0.0.0/0
    - HTTPS (443): 0.0.0.0/0
    - API (3000): 0.0.0.0/0（開発用、本番では80/443のみ）
  
  アウトバウンド:
    - All: 0.0.0.0/0

コスト: $0（無料枠内）
```

#### インスタンス起動スクリプト
```bash
#!/bin/bash

# システム更新
sudo yum update -y

# Docker インストール
sudo yum install -y docker
sudo systemctl start docker
sudo systemctl enable docker
sudo usermod -a -G docker ec2-user

# Docker Compose インストール
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# Git インストール
sudo yum install -y git

# Node.js インストール（管理用）
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 18
nvm use 18
```

---

### 2. Docker Compose 構成

#### docker-compose.yml
```yaml
version: '3.8'

services:
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - api
    restart: unless-stopped
    mem_limit: 128m

  api:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=speedmatch
      - DB_USER=admin
      - DB_PASSWORD=${DB_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      - postgres
    restart: unless-stopped
    mem_limit: 512m

  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=speedmatch
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    mem_limit: 256m
    command: 
      - "postgres"
      - "-c"
      - "max_connections=50"
      - "-c"
      - "shared_buffers=128MB"

volumes:
  postgres_data:
```

**メモリ配分:**
- Nginx: 128MB
- API: 512MB
- PostgreSQL: 256MB
- システム: 100MB
- 合計: 約1GB（ギリギリだが動作可能）

#### nginx.conf
```nginx
events {
    worker_connections 1024;
}

http {
    upstream api {
        server api:3000;
    }

    # HTTP → HTTPS リダイレクト（SSL設定時）
    server {
        listen 80;
        server_name _;
        return 301 https://$host$request_uri;
    }

    # API サーバー
    server {
        listen 443 ssl;
        server_name api.yourdomain.com;

        # 自己署名証明書（Let's Encrypt推奨）
        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;

        location / {
            proxy_pass http://api;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # ヘルスチェック
        location /health {
            proxy_pass http://api/health;
            access_log off;
        }
    }
}
```

---

### 3. フロントエンド (S3 静的ホスティング)

#### S3設定
```yaml
バケット名: speedmatch-frontend-[random]
リージョン: ap-northeast-1

静的ウェブサイトホスティング:
  有効: はい
  インデックスドキュメント: index.html
  エラードキュメント: index.html

パブリックアクセス:
  - ブロックパブリックアクセス: オフ（静的サイト用）
  
バケットポリシー:
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "PublicReadGetObject",
      "Effect": "Allow",
      "Principal": "*",
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::speedmatch-frontend-*/*"
    }
  ]
}

コスト: $0-1/月（5GB無料枠内）
```

#### デプロイスクリプト
```bash
#!/bin/bash
# deploy-frontend.sh

# ビルド
npm run build

# S3へアップロード
aws s3 sync dist/ s3://speedmatch-frontend-xxx/ --delete

# キャッシュクリア（CloudFront使用時）
# aws cloudfront create-invalidation --distribution-id XXX --paths "/*"

echo "デプロイ完了！"
echo "URL: http://speedmatch-frontend-xxx.s3-website-ap-northeast-1.amazonaws.com"
```

---

### 4. CI/CD (CodePipeline + CodeBuild)

#### buildspec.yml
```yaml
version: 0.2

phases:
  pre_build:
    commands:
      - echo Logging in to EC2...
      
  build:
    commands:
      - echo Build started on `date`
      - echo Building Docker image...
      - docker build -t speedmatch-api .
      
  post_build:
    commands:
      - echo Build completed on `date`
      - echo Deploying to EC2...
      # SSHでEC2に接続してデプロイ
      - |
        ssh -o StrictHostKeyChecking=no ec2-user@$EC2_HOST << 'EOF'
          cd /home/ec2-user/speedmatch-backend
          git pull origin main
          docker-compose down
          docker-compose up -d --build
        EOF

artifacts:
  files:
    - '**/*'
```

#### CodePipeline設定（無料）
```yaml
パイプライン名: speedmatch-pipeline
ステージ:
  1. Source: GitHub
  2. Build: CodeBuild (無料枠: 100分/月)
  3. Deploy: カスタムアクション（SSH経由）

コスト: $0（1パイプライン無料）
```

---

## 🔧 セットアップ手順

### Step 1: EC2インスタンス起動
```bash
# AWS CLIでインスタンス起動
aws ec2 run-instances \
  --image-id ami-0d48337b7d3c86f62 \  # Amazon Linux 2023
  --instance-type t3.micro \
  --key-name your-key-pair \
  --security-group-ids sg-xxxxx \
  --subnet-id subnet-xxxxx \
  --user-data file://user-data.sh \
  --tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=speedmatch-server}]'
```

### Step 2: EC2に接続してセットアップ
```bash
# SSH接続
ssh -i your-key.pem ec2-user@ec2-xx-xx-xx-xx.compute.amazonaws.com

# アプリケーションクローン
git clone https://github.com/your-org/speedmatch-backend.git
cd speedmatch-backend

# 環境変数設定
cat > .env << EOF
DB_PASSWORD=your-secure-password
JWT_SECRET=your-jwt-secret
NODE_ENV=production
EOF

# Docker Compose起動
docker-compose up -d

# ログ確認
docker-compose logs -f
```

### Step 3: フロントエンドデプロイ
```bash
# S3バケット作成
aws s3 mb s3://speedmatch-frontend-12345

# 静的ホスティング有効化
aws s3 website s3://speedmatch-frontend-12345 \
  --index-document index.html \
  --error-document index.html

# ビルド＆デプロイ
cd speedmatch-frontend
npm run build
aws s3 sync dist/ s3://speedmatch-frontend-12345/ --delete
```

### Step 4: ドメイン設定（オプション）
```bash
# Route 53ホストゾーン作成（$0.50/月）
aws route53 create-hosted-zone --name yourdomain.com --caller-reference $(date +%s)

# Aレコード追加
# EC2のパブリックIPを指定
```

---

## 💡 さらなるコスト削減テクニック

### 1. スポットインスタンス利用（開発用）
```yaml
# 最大90%オフ（中断リスクあり）
インスタンス購入オプション: スポット
最大料金: オンデマンドの50%

コスト削減: 月額 $10 → $1
※ 開発環境のみ推奨
```

### 2. インスタンススケジューリング
```bash
# 夜間・週末停止（50%削減）
# Lambda + EventBridge で自動化

# 停止スケジュール
# 平日: 21:00-9:00 停止（12時間）
# 週末: 全停止

# 実質稼働時間: 月360時間（無料枠750時間内）
```

### 3. CloudFront不使用
```yaml
# S3直接アクセスで$0
# 速度は多少落ちるが許容範囲

S3 Website Endpoint:
  http://bucket-name.s3-website-region.amazonaws.com
  
コスト: $0
```

### 4. RDS不使用（EC2内PostgreSQL）
```yaml
# RDS 750時間/月は1台のみ無料
# EC2内でPostgreSQL稼働させて完全無料化

メリット: $0
デメリット: 
  - バックアップは手動
  - スケールしにくい
  
開発用には十分
```

### 5. Elastic IP不使用
```yaml
# パブリックIPは無料
# Elastic IPは月額 $3.6

対策:
  - Dynamic DNSサービス利用（無料）
  - パブリックIP変更時にDNS更新

コスト削減: $3.6/月
```

---

## 📊 最終コスト見積もり

### パターンA: 完全無料構成（無料枠内）
```
EC2 t3.micro: $0（750時間無料）
S3: $0（5GB無料）
データ転送: $0（15GB無料）
CodePipeline: $0（1パイプライン無料）
CodeBuild: $0（100分無料）

合計: $0/月 ✨
```

### パターンB: 最小コスト構成
```
EC2 t3.micro: $0（無料枠）
RDS db.t3.micro: $0（無料枠）
S3: $0（無料枠内）
Route53: $0.50（ホストゾーン）
データ転送超過分: $1-2

合計: $1.5-3/月
```

### パターンC: 24時間稼働（無料枠後）
```
EC2 t3.micro: $7.5
S3: $1
データ転送: $2
Route53: $0.50

合計: $11/月
```

---

## 🎯 推奨構成まとめ

### 開発初期（3-12ヶ月）
```
✅ EC2 t3.micro 1台（APIとDB同居）
✅ S3 静的ホスティング
✅ パブリックIP（Elastic IP不使用）
✅ CodePipeline 1パイプライン
✅ 夜間停止スケジュール

月額: $0-3
```

### この構成の利点
1. ✅ **完全にAWSネイティブ** - 本格的な構成
2. ✅ **ほぼ無料** - 無料枠フル活用
3. ✅ **スケール可能** - 必要に応じて拡張
4. ✅ **学習価値高い** - 本番環境と同じ技術

---

## 🚀 次のステップ

1. **AWSアカウント作成**（無料枠12ヶ月）
2. **EC2起動**（t3.micro）
3. **Docker Compose設定**
4. **アプリデプロイ**
5. **S3フロントエンド配信**

この構成で進めましょうか？